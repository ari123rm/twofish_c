#include "twofish.h"
#include <stdio.h>
#include <string.h>
#include <stdlib.h>

#include "std_defs.h"
#define Q_TABLES
#define M_TABLE
#define MK_TABLE
#define ONE_STEP




static char *alg_name[] = { "twofish", "twofish.c", "twofish" };
char **cipher_name(void) { return alg_name; }

u4byte k_len;
u4byte l_key[40];
u4byte s_key[4];

/* GF(2^8) arithmetic */
#define G_M 0x0169
const u1byte tab_5b[4] = {0, G_M >> 2, G_M >> 1, (G_M >> 1) ^ (G_M >> 2)};
const u1byte tab_ef[4] = {0, (G_M >> 1) ^ (G_M >> 2), G_M >> 1, G_M >> 2};

#define ffm_01(x) (x)
#define ffm_5b(x) ((x) ^ ((x) >> 2) ^ tab_5b[(x) & 3])
#define ffm_ef(x) ((x) ^ ((x) >> 1) ^ ((x) >> 2) ^ tab_ef[(x) & 3])

const u1byte ror4[16] = {0, 8, 1, 9, 2, 10, 3, 11, 4, 12, 5, 13, 6, 14, 7, 15};
const u1byte ashx[16] = {0, 9, 2, 11, 4, 13, 6, 15, 8, 1, 10, 3, 12, 5, 14, 7};

const u1byte qt0[2][16] = {
    {8, 1, 7, 13, 6, 15, 3, 2, 0, 11, 5, 9, 14, 12, 10, 4},
    {2, 8, 11, 13, 15, 7, 6, 14, 3, 1, 9, 4, 0, 10, 12, 5}
};
const u1byte qt1[2][16] = {
    {14, 12, 11, 8, 1, 2, 3, 5, 15, 4, 10, 6, 7, 0, 9, 13},
    {1, 14, 2, 11, 4, 12, 3, 7, 6, 13, 10, 5, 15, 9, 0, 8}
};
const u1byte qt2[2][16] = {
    {11, 10, 5, 14, 6, 13, 9, 0, 12, 8, 15, 3, 2, 4, 7, 1},
    {4, 12, 7, 5, 1, 6, 9, 10, 0, 14, 13, 8, 2, 11, 3, 15}
};
const u1byte qt3[2][16] = {
    {13, 7, 15, 4, 1, 2, 6, 14, 9, 11, 3, 0, 8, 5, 12, 10},
    {11, 9, 5, 1, 12, 3, 13, 14, 6, 4, 7, 15, 2, 0, 8, 10}
};

u1byte qp(const u4byte n, const u1byte x)
{
    u1byte a0, a1, a2, a3, a4, b0, b1, b2, b3, b4;
    a0 = x >> 4; b0 = x & 15;
    a1 = a0 ^ b0; b1 = ror4[b0] ^ ashx[a0];
    a2 = qt0[n][a1]; b2 = qt1[n][b1];
    a3 = a2 ^ b2; b3 = ror4[b2] ^ ashx[a2];
    a4 = qt2[n][a3]; b4 = qt3[n][b3];
    return (b4 << 4) | a4;
}

#ifdef Q_TABLES
u4byte qt_gen = 0;
u1byte q_tab[2][256];
#define q(n, x) q_tab[n][x]
void gen_qtab(void)
{
    u4byte i;
    for (i = 0; i < 256; ++i) {
        q(0, i) = qp(0, (u1byte)i);
        q(1, i) = qp(1, (u1byte)i);
    }
}
#else
#define q(n,x) qp(n,x)
#endif

#ifdef M_TABLE
u4byte mt_gen = 0;
const u4byte m_tab[4][256] ={{-1128517003,-320069133,538985414,-1280062988,-623246373,33721211,-488494085,-1633748280,-909513654,-724301357,404253670,505323371,-1734865339,-1296942979,-1499016472,640071499,1010587606,-1819047374,-2105348392,1381144829,2071712823,-1145358479,1532729329,1195869153,606354480,1364320783,-1162164488,1246425883,-1077983097,218984698,-1330597114,1970658879,-757924514,2105352378,1717973422,976921435,1499012234,0,-842165316,437969053,-1364317075,2139073473,724289457,-1094797042,-522149760,-1970663331,993743570,1684323029,-656897888,-404249212,1600120839,454758676,741130933,-50547568,825304876,-2139069021,1936927410,202146163,2037997388,1802191188,1263207058,1397975412,-1802203338,-2088558767,707409464,-993747792,572704957,-707397542,-1111636996,1212708960,-12702,1280051094,1094809452,-943200702,-336911113,471602192,1566401404,909517352,1734852647,-370561140,1145370899,336915093,-168445028,-808511289,1061104932,-1061100730,1920129851,1414818928,690572490,-252693021,134807173,-960096309,-202158319,-1936923440,-1532733037,-892692808,1751661478,-1195881085,943204384,-437965057,-1381149025,185304183,-926409277,-1717960756,1482222851,421108335,235801096,-1785364801,1886408768,-134795033,1852755755,522153698,-1246413447,151588620,1633760426,1465325186,-1616966847,-1650622406,286352618,623234489,-1347428892,1162152090,-538997340,-1549575017,-353708674,892688602,-303181702,1128528919,-117912730,-67391084,926405537,-84262883,-1027446723,-1263219472,842161630,-1667468877,1448535819,-471606670,-2021171033,353704732,-101106961,1667481553,875866451,-1701149378,-1313783153,2088554803,-2004313306,1027450463,-1583228948,-454762634,-2122214358,-1852767927,252705665,-286348664,370565614,-673746143,-1751648828,-1515870182,-16891925,1835906521,2021174981,-976917191,488498585,1987486925,1044307117,-875862223,-1229568117,-269526271,303177240,1616954659,1785376989,1296954911,-825300658,-555844563,1431674361,2122209864,555856463,50559730,-1600117147,1583225230,1515873912,1701137244,1650609752,-33733351,101119117,1077970661,-218972520,859024471,387420263,84250239,-387424763,1330609508,-1987482961,269522275,1953771446,168457726,1549570805,-1684310857,757936956,808507045,774785486,1229556201,1179021928,2004309316,-1465329440,-1768553395,673758531,-1448531607,-640059095,-2038001362,-774797396,-185316843,-1920133799,-690584920,-1179010038,1111625118,-151600786,791656519,-572717345,589510964,-859020747,-235813782,-1044311345,-2054820900,-1886413278,1903272393,-1869549376,-1431678053,16904585,-1953766956,1313770733,-1903267925,-1414815214,1869561506,-421112819,-606342574,-1835893829,-1212697086,1768540719,960092585,-741143337,-1482218655,-1566397154,-1010591308,1819034704,117900548,67403766,656885442,-1397971178,-791644635,1347425158,-589498538,-2071717291,-505327351,2054825406,320073617},
		{-1445381831,1737496343,-1284399972,-388847962,67438343,-40349102,-1553629056,1994384612,-1710734011,-1845343413,-2136940320,2019973722,-455233617,-575640982,-775986333,943073834,223667942,-968679392,895667404,-1732316430,404623890,-148575253,-321412703,1819754817,1136470056,1966259388,936672123,647727240,-93319923,335103044,-1800274949,1213890174,-226884861,-790328180,-1958234442,809247780,-2069501977,1413573483,-553198115,600137824,424017405,1537423930,1030275778,1494584717,-215880468,-1372494234,-1572966545,-2112465065,1670713360,22802415,-2092058440,781289094,-642421395,1361019779,-1689015638,2086886749,-1506056088,-348127490,-1512689616,-1104840070,380087468,202311945,-483004176,1629726631,-1057976176,-1934628375,981507485,-174957476,1937837068,740766001,628543696,199710294,-1149529454,1323945678,-1980694271,1805590046,1403597876,1791291889,-1264991293,-241738917,-511490233,-429189096,-1110957534,1158584472,-496099553,-188107853,-1238403980,1724643576,-855664231,-1779821548,65886296,1459084508,-723416181,471536917,514695842,-687025197,-81009950,-1021458232,-1910940066,-1245565908,-376878775,-820854335,-1082223211,-1172275843,-362540783,2005142283,963495365,-1351972471,869366908,-912166543,1657733119,1899477947,-2114253041,2034087349,156361185,-1378075074,606945087,-844859786,-107129515,-655457662,-444186560,-978421640,-1177737947,1292146326,1146451831,134876686,-2045554608,-416221193,-1579993289,490797818,-1439407775,-309572018,112439472,1886147668,-1305840781,-766362821,1091280799,2072707586,-1601644328,290452467,828885963,-1035589849,666920807,-1867186948,539506744,-159448060,1618495560,-13703707,-1777906612,1548445029,-1312347349,-1418752370,-1643298238,-1665403403,1391647707,468929098,1604730173,-1822841692,180140473,-281347591,-1846602989,-2046949368,1224839569,-295627242,763158238,1337073953,-1891454543,1004237426,1203253039,-2025275457,1831644846,1189331136,-698926020,1048943258,1764338089,1685933903,714375553,-834064850,-887634234,801794409,-54280771,-1755536477,90106088,2060512749,-1400385071,2140013829,-709204892,447260069,1270294054,247054014,-1486846073,1526257109,673330742,336665371,1071543669,695851481,-2002063634,1009986861,1281325433,45529015,-1198077238,-631753419,-1331903292,402408259,1427801220,536235341,-1977853607,2100867762,1470903091,-954675249,-1913387514,1953059667,-1217094757,-990537833,-1621709395,1926947811,2127948522,357233908,580816783,312650667,1481532002,132669279,-1713038051,876159779,1858205430,1346661484,-564317646,1752319558,1697030304,-1131164211,-620504358,-121193798,-923099490,-1467820330,735014510,1079013488,-588544635,-25884150,847942547,-1534205985,-900978391,269753372,561240023,-255019852,-754330412,1561365130,266490193,0,1872369945,-1646257638,915379348,1122420679,1257032137,1593692882,-1045725313,-522671960},
		{-1133134798,-319558623,549855299,-1275808823,-623126013,41616011,-486809045,-1631019270,-917845524,-724315127,417732715,510336671,-1740269554,-1300385224,-1494702382,642459319,1020673111,-1825401974,-2099739922,1392333464,2067233748,-1150174409,1542544279,1205946243,607134780,1359958498,-1158104378,1243302643,-1081622712,234491248,-1341738829,1967093214,-765537539,2109373728,1722705457,979057315,1502239004,0,-843264621,446503648,-1368543700,2143387563,733031367,-1106329927,-528424800,-1973581296,1003633490,1691706554,-660547448,-410720347,1594318824,454302481,750070978,-57606988,824979751,-2136768411,1941074730,208866433,2035054943,1800694593,1267878658,1400132457,-1808362353,-2091810017,708323894,-995048292,582820552,-715467272,-1107509821,1214269560,-10289202,1284918279,1097613687,-951924762,-336073948,470817812,1568431459,908604962,1730635712,-376641105,1142113529,345314538,-174262853,-808988904,1059340077,-1069104925,1916498651,1416647788,701114700,-253497291,142936318,-959724009,-216927409,-1932489500,-1533828007,-893859178,1755736123,-1199327155,941635624,-436214482,-1382044330,192351108,-926693347,-1714644481,1476614381,426711450,235408906,-1782606466,1883271248,-135792848,1848340175,534912878,-1250314947,151783695,1638555956,1468159766,-1623089397,-1657102976,300552548,632890829,-1343967267,1167738120,-542842995,-1550343332,-360781099,903492952,-310710832,1125598204,-127469365,-74122319,933312467,-98698688,-1036139928,-1259293492,853422685,-1665950607,1443583719,-479009830,-2019063968,354161947,-101713606,1674666943,877868201,-1707173243,-1315983038,2083749073,-2010740581,1029651878,-1578327593,-461970209,-2127920748,-1857449727,260116475,-293015894,384702049,-685648013,-1748723723,-1524980312,-18088385,1842965941,2026207406,-986069651,496573925,1993176740,1051541212,-885929113,-1232357817,-285085861,303567390,1612931269,1792895664,1293897206,-833696023,-567419268,1442403741,2118680154,558834098,66192250,-1603952602,1586388505,1517836902,1700554059,1649959502,-48628411,109905652,1088766086,-224857410,861352876,392632208,92210574,-402266018,1331974013,-1984984726,274927765,1958114351,184420981,1559583890,-1682465932,758918451,816132310,785264201,1240025481,1181238898,2000975701,-1461671720,-1773300220,675489981,-1452693207,-651568775,-2043771247,-777203321,-199887798,-1923511019,-693578110,-1190479428,1117667853,-160500031,793194424,-572531450,590619449,-868889502,-244649532,-1043349230,-2049145365,-1893560418,1909027233,-1866428176,-1432638893,25756145,-1949004831,1324174988,-1901359505,-1424839774,1872916286,-435296684,-615326734,-1833201029,-1224558666,1764714954,967391705,-740830452,-1486772445,-1575050579,-1011563623,1817209924,117704453,83231871,667035462,-1407800153,-802828170,1350979603,-598287113,-2074770406,-519446191,2059303461,328274927},
		{-650532391,-1877514352,1906094961,-760813358,84345861,-1739391592,1702929253,-538675489,138779144,38507010,-1595899744,1717205094,-575675171,-1335173712,-1083977281,908736566,1424362836,1126221379,1657550178,-1091397442,504502302,619444004,-677253929,2000776311,-1121434691,851211570,-730122284,-1685576037,1879964272,-112978951,-1308912463,1518225498,2047079034,-460533532,1203145543,1009004604,-1511553883,1097552961,115203846,-983555131,1174214981,-1556456541,1757560168,361584917,569176865,828812849,1047503422,374833686,-1794088043,1542390107,1303937869,-1853477231,-1251092043,528699679,1403689811,1667071075,996714043,1073670975,-701454890,628801061,-1481894233,252251151,904979253,598171939,-258948880,-1343648593,-2137179520,-1839401582,-2129890431,657533991,1993352566,-413791257,2073213819,-372355351,-251557391,-1625396321,-1456188503,-990811452,-1715227495,-1755582057,-2092441213,1796793963,-937247288,244860174,1847583342,-910953271,796177967,-872913205,-6697729,-367749654,-312998931,-136554761,-510929695,454368283,-1381884243,215209740,736295723,499696413,425627161,-1037257278,-1991644791,314691346,2123743102,545110560,1678895716,-2079623292,1841641837,1787408234,-780389423,-1586378335,-822123826,935031095,-82869765,1035303229,1373702481,-599872036,759112749,-1535717980,-1655309923,-293414674,-2042567290,-1367816786,-853165619,76958980,1433879637,168691722,324044307,821552944,-751328813,1090133312,878815796,-1940984436,-1280309581,1817473132,712225322,1379652178,194986251,-1962771573,-1999069048,1341329743,1741369703,1177010758,-1066981440,-1258516300,674766888,2131031679,2018009208,786825006,122459655,1264933963,-953437753,1871620975,222469645,-1141531461,-220507406,-213246989,-1505927258,1503957849,-1128723780,989458234,-283930129,-32995842,26298625,1628892769,2094935420,-1306439758,1118932802,-613270565,-1204861000,1220511560,749628716,-473938205,1463604823,-2053489019,698968361,2102355069,-1803474284,1227804233,398904087,-899076150,-1010959165,1554224988,1592264030,-789742896,-2016301945,-1912242290,-1167796806,-1465574744,-1222227017,-1178726727,1619502944,-120235272,573974562,286987281,-562741282,2044275065,-1427208022,858602547,1601784927,-1229520202,-1765099370,1479924312,-1664831332,-62711812,444880154,-162717706,475630108,951221560,-1405921364,416270104,-200897036,1767076969,1956362100,-174603019,1454219094,-622628134,-706052395,1257510218,-1634786658,-1565846878,1315067982,-396425240,-451044891,958608441,-1040814399,1147949124,1563614813,1917216882,648045862,-1815233389,64674563,-960825146,-90257158,-2099861374,-814863409,1349533776,-343548693,1963654773,-1970064758,-1914723187,1277807180,337383444,1943478643,-860557108,164942601,277503248,-498003998,0,-1709609062,-535126560,-1886112113,-423148826,-322352404,-36544771,-1417690709,-660021032}};
#define mds(n,x) m_tab[n][x]
#endif

/* h_fun */
u4byte h_fun(const u4byte x, const u4byte key[])
{
    u4byte b0 = byte(x,0), b1 = byte(x,1), b2 = byte(x,2), b3 = byte(x,3);

    switch(k_len) {
        case 4:
            b0 = q(1,b0) ^ byte(key[3],0);
            b1 = q(0,b1) ^ byte(key[3],1);
            b2 = q(0,b2) ^ byte(key[3],2);
            b3 = q(1,b3) ^ byte(key[3],3);
            /* fallthrough */
        case 3:
            b0 = q(1,b0) ^ byte(key[2],0);
            b1 = q(1,b1) ^ byte(key[2],1);
            b2 = q(0,b2) ^ byte(key[2],2);
            b3 = q(0,b3) ^ byte(key[2],3);
            /* fallthrough */
        case 2:
            b0 = q(0,q(0,b0) ^ byte(key[1],0)) ^ byte(key[0],0);
            b1 = q(0,q(1,b1) ^ byte(key[1],1)) ^ byte(key[0],1);
            b2 = q(1,q(0,b2) ^ byte(key[1],2)) ^ byte(key[0],2);
            b3 = q(1,q(1,b3) ^ byte(key[1],3)) ^ byte(key[0],3);
            break;
    }
    return mds(0,b0) ^ mds(1,b1) ^ mds(2,b2) ^ mds(3,b3);
}

/* prototype for mds_rem */
u4byte mds_rem(u4byte p0, u4byte p1);

/* MK_TABLE */
#ifdef MK_TABLE
#ifdef ONE_STEP
const u4byte mk_tab[4][256] = {{-1734865339,-1819047374,656885442,1263207058,218984698,1600120839,555856463,-724301357,-1970663331,842161630,-875862223,-1145358479,-16891925,-505327351,-2054820900,404253670,690572490,-707397542,-1566397154,421108335,-168445028,84250239,117900548,1852755755,-471606670,-640059095,-2122214358,1684323029,-303181702,1094809452,-791644635,1195869153,-741143337,1734852647,976921435,-1499016472,353704732,-404249212,1313770733,-1869549376,1987486925,1566401404,-1532733037,589510964,-2021171033,-960096309,-1296942979,1431674361,1819034704,-1246413447,134807173,1145370899,1667481553,-1684310857,1532729329,-1701149378,-842165316,1027450463,-1482218655,1549570805,-437965057,-589498538,774785486,1482222851,-825300658,-1852767927,926405537,-134795033,-808511289,1397975412,1061104932,1111625118,-387424763,437969053,1465325186,-976917191,2088554803,-421112819,-67391084,791656519,-2088558767,370565614,1246425883,741130933,-606342574,-1128517003,1162152090,-84262883,538985414,-1515870182,1751661478,-101106961,-269526271,252705665,1448535819,-185316843,185304183,-286348664,2139073473,-1061100730,-1751648828,-218972520,1229556201,2021174981,-454762634,-117912730,-757924514,2004309316,-1229568117,859024471,-1600117147,-1549575017,168457726,-202158319,572704957,-859020747,16904585,-673746143,724289457,2037997388,-320069133,707409464,-538997340,943204384,-370561140,454758676,-1162164488,1650609752,387420263,67403766,-1397971178,1717973422,1381144829,1953771446,202146163,-993747792,-1920133799,-2004313306,-12702,2122209864,522153698,-252693021,-656897888,-151600786,-774797396,-1094797042,320073617,-1717960756,-555844563,606354480,1296954911,993743570,-1886413278,-50547568,-623246373,-1313783153,0,1010587606,303177240,-1179010038,1920129851,-1044311345,960092585,-1212697086,505323371,875866451,1280051094,-1768553395,1869561506,2054825406,-1802203338,-353708674,-1465329440,-943200702,1768540719,-572717345,-1616966847,1414818928,-1414815214,-1936923440,1515873912,808507045,151588620,-1195881085,471602192,909517352,235801096,-1027446723,-488494085,-2038001362,1886408768,336915093,-1364317075,1364320783,1330609508,1802191188,-522149760,1179021928,50559730,-235813782,-1077983097,-2139069021,2105352378,-336911113,-1010591308,-1263219472,269522275,1583225230,-1280062988,-690584920,-892692808,1701137244,-1347428892,1499012234,1128528919,-909513654,-926409277,-1111636996,-1667468877,1212708960,-1330597114,1347425158,1936927410,-1903267925,673758531,-1650622406,-33733351,-1448531607,1077970661,101119117,-2105348392,-1633748280,623234489,1616954659,1044307117,892688602,-1785364801,-1953766956,825304876,1835906521,640071499,488498585,33721211,-1987482961,1903272393,286352618,-1835893829,-2071717291,-1381149025,1785376989,-1431678053,1633760426,757936956,2071712823,-1583228948,1970658879},
		{-1665403403,312650667,-575640982,539506744,247054014,-1104840070,1213890174,-790328180,1004237426,-1172275843,-309572018,-1646257638,-1534205985,-553198115,-1822841692,335103044,1831644846,-912166543,-522671960,-1958234442,-1331903292,1899477947,740766001,-2046949368,1966259388,-2112465065,-215880468,1526257109,606945087,-1467820330,2019973722,-1110957534,-775986333,-2092058440,1091280799,963495365,-1643298238,809247780,1886147668,-1845343413,-1913387514,-1601644328,-13703707,-1057976176,-1131164211,1629726631,-1779821548,-281347591,-1553629056,1604730173,673330742,-1512689616,2034087349,1292146326,2005142283,2086886749,-1980694271,536235341,-1579993289,-496099553,828885963,-1977853607,1548445029,1537423930,-1486846073,1071543669,156361185,-376878775,-93319923,424017405,-620504358,336665371,1048943258,1752319558,-1506056088,-121193798,-564317646,2140013829,1872369945,1937837068,1361019779,-255019852,-1867186948,1764338089,1413573483,132669279,695851481,1391647707,-2025275457,1819754817,1994384612,65886296,1805590046,2100867762,-855664231,180140473,1009986861,2127948522,-2045554608,-954675249,-241738917,714375553,1403597876,-2069501977,1953059667,-2114253041,-1372494234,876159779,-990537833,1270294054,-655457662,1346661484,-1846602989,-1149529454,468929098,1281325433,981507485,869366908,-923099490,561240023,-1264991293,-1800274949,-81009950,1494584717,1481532002,1122420679,-1710734011,-887634234,1670713360,45529015,357233908,-1777906612,0,-1400385071,1030275778,-321412703,1224839569,1724643576,1926947811,-1934628375,1657733119,-444186560,-483004176,-754330412,447260069,-631753419,380087468,134876686,90106088,112439472,223667942,1561365130,-1621709395,847942547,1427801220,628543696,-1238403980,895667404,-1418752370,-226884861,-1021458232,-588544635,-820854335,-1755536477,1323945678,735014510,1257032137,-455233617,-388847962,2060512749,202311945,514695842,-511490233,-159448060,-429189096,1470903091,1146451831,-698926020,471536917,1136470056,-1035589849,-1439407775,-1177737947,199710294,2072707586,-40349102,1337073953,-1445381831,-709204892,-1217094757,1079013488,-723416181,-2002063634,-1713038051,1685933903,-1312347349,-900978391,-295627242,402408259,404623890,-348127490,490797818,580816783,-834064850,-1082223211,915379348,600137824,-148575253,1697030304,1593692882,266490193,1189331136,1858205430,290452467,-174957476,-107129515,-188107853,763158238,-766362821,-1689015638,-1284399972,1737496343,943073834,1791291889,-1198077238,-844859786,-1891454543,936672123,-2136940320,-642421395,647727240,-1305840781,1618495560,-25884150,801794409,-1245565908,-687025197,-1045725313,-362540783,-416221193,1203253039,-1378075074,-1732316430,67438343,-54280771,781289094,-1910940066,666920807,-978421640,22802415,269753372,-1351972471,1459084508,-1572966545,-968679392,1158584472},
		{-651568775,-1036139928,83231871,1916498651,1722705457,733031367,-1857449727,1848340175,793194424,-2091810017,-1407800153,-1866428176,877868201,-833696023,-802828170,1476614381,667035462,-319558623,109905652,417732715,632890829,1730635712,-2010740581,-598287113,-48628411,2118680154,1542544279,274927765,66192250,-1382044330,816132310,941635624,-1740269554,345314538,-868889502,-885929113,861352876,-1893560418,-959724009,-1782606466,-572531450,1755736123,2109373728,184420981,25756145,1214269560,328274927,558834098,534912878,-10289202,-461970209,392632208,1638555956,1517836902,-1486772445,235408906,446503648,-528424800,-1524980312,1267878658,142936318,303567390,1612931269,1568431459,1674666943,-1432638893,-926693347,-1150174409,454302481,1243302643,1792895664,824979751,-623126013,151783695,758918451,-2099739922,1967093214,470817812,-1259293492,-1631019270,-101713606,853422685,234491248,-1901359505,-843264621,708323894,1392333464,-1932489500,1020673111,-1043349230,-253497291,-2074770406,1764714954,-1825401974,-685648013,2059303461,-615326734,-986069651,-1106329927,-1773300220,1842965941,-1133134798,1468159766,1293897206,675489981,384702049,1594318824,-1158104378,2067233748,-1232357817,1324174988,1003633490,-410720347,-224857410,-1808362353,-402266018,2035054943,-1748723723,1359958498,192351108,785264201,-724315127,903492952,1993176740,-436214482,-285085861,510336671,-1424839774,-1550343332,-1714644481,1442403741,-715467272,-765537539,967391705,-951924762,1181238898,1400132457,1125598204,-360781099,2026207406,-2136768411,-1275808823,-1707173243,-1199327155,-1190479428,1909027233,607134780,-486809045,-244649532,-1250314947,-660547448,-216927409,496573925,-18088385,-893859178,701114700,-519446191,1502239004,-1452693207,1443583719,-1578327593,-1575050579,2143387563,1142113529,-1833201029,208866433,-293015894,-1069104925,908604962,260116475,92210574,1117667853,1331974013,1958114351,300552548,582820552,1800694593,-1461671720,-199887798,-1011563623,1883271248,-693578110,2000975701,-310710832,-1341738829,1205946243,1284918279,1029651878,1416647788,1350979603,1872916286,1240025481,1586388505,1649959502,-160500031,1051541212,-1494702382,-98698688,-2049145365,41616011,-1949004831,-74122319,-542842995,1817209924,-2043771247,-1300385224,-1315983038,1088766086,-479009830,549855299,1691706554,-740830452,-808988904,-435296684,-1107509821,1167738120,-1657102976,-1923511019,-1603952602,642459319,-1533828007,-127469365,933312467,-1368543700,-917845524,354161947,-2019063968,1941074730,-135792848,-567419268,-57606988,-1973581296,-995048292,590619449,-174262853,-1343967267,2083749073,1059340077,0,1700554059,-2127920748,-336073948,1559583890,-1623089397,-1665950607,-1081622712,1097613687,-376641105,979057315,426711450,-777203321,-1224558666,117704453,750070978,-1682465932,-1984984726},
		{-1815233389,-451044891,1174214981,569176865,-1178726727,-2053489019,-730122284,38507010,2047079034,-953437753,-1037257278,-112978951,-1427208022,1035303229,1993352566,2073213819,1619502944,-62711812,698968361,215209740,-312998931,-283930129,-200897036,1678895716,324044307,1787408234,-2137179520,-1803474284,-1999069048,1009004604,-814863409,252251151,2102355069,361584917,-1204861000,-1914723187,736295723,1227804233,-1709609062,-1970064758,749628716,-1367816786,-1251092043,-983555131,-1091397442,-1595899744,858602547,-1912242290,-960825146,-413791257,-990811452,1454219094,-1040814399,-599872036,545110560,1592264030,-1417690709,-1565846878,-1222227017,-1258516300,851211570,996714043,314691346,-220507406,76958980,-1167796806,908736566,1796793963,-535126560,122459655,-1128723780,-1886112113,-613270565,1403689811,1257510218,1373702481,1554224988,-1308912463,648045862,1871620975,1433879637,444880154,-1465574744,573974562,504502302,-1381884243,-1655309923,1563614813,1220511560,-622628134,878815796,2018009208,628801061,337383444,-1010959165,951221560,1315067982,-36544771,-174603019,-213246989,-1991644791,1943478643,-343548693,398904087,-1685576037,-293414674,64674563,277503248,-120235272,-660021032,-1839401582,1118932802,454368283,904979253,-1229520202,-6697729,-780389423,1463604823,-1715227495,1963654773,-460533532,-1505927258,1841641837,-2042567290,1277807180,194986251,-1335173712,138779144,-1535717980,989458234,-562741282,712225322,674766888,-1739391592,-1343648593,-2092441213,-677253929,-251557391,1379652178,1090133312,1203145543,1667071075,1097552961,1628892769,1349533776,-1877514352,-367749654,1741369703,2094935420,-1511553883,-899076150,1657550178,26298625,935031095,1956362100,-1625396321,-1083977281,164942601,1757560168,-162717706,-650532391,-789742896,-2129890431,759112749,1702929253,-1405921364,168691722,2131031679,-1556456541,1917216882,-1634786658,-872913205,-136554761,1303937869,222469645,-1940984436,2000776311,-706052395,-498003998,-1141531461,1424362836,-2016301945,-751328813,-1121434691,1047503422,-1306439758,-822123826,-1664831332,-910953271,-90257158,115203846,-1456188503,528699679,-1280309581,1879964272,-760813358,-258948880,-1481894233,-32995842,1767076969,-82869765,796177967,1264933963,1601784927,-853165619,-860557108,425627161,374833686,-1586378335,-937247288,2123743102,-1962771573,2044275065,499696413,-1853477231,-1794088043,0,1542390107,-322352404,821552944,286987281,1503957849,-423148826,1717205094,-2099861374,1341329743,-396425240,1847583342,598171939,-1066981440,416270104,-1755582057,1906094961,657533991,1479924312,-510929695,1073670975,-701454890,828812849,-1765099370,-538675489,-372355351,84345861,-575675171,619444004,1126221379,1817473132,1177010758,1518225498,475630108,786825006,1147949124,-2079623292,958608441,244860174,-473938205}};

#else
u1byte sb[4][256];
#endif

#define q20(x) (q(0,q(0,(x)) ^ byte(key[1],0)) ^ byte(key[0],0))
#define q21(x) (q(0,q(1,(x)) ^ byte(key[1],1)) ^ byte(key[0],1))
#define q22(x) (q(1,q(0,(x)) ^ byte(key[1],2)) ^ byte(key[0],2))
#define q23(x) (q(1,q(1,(x)) ^ byte(key[1],3)) ^ byte(key[0],3))

#define q30(x) (q(0,q(0,q(1,(x)) ^ byte(key[2],0)) ^ byte(key[1],0)) ^ byte(key[0],0))
#define q31(x) (q(0,q(1,q(1,(x)) ^ byte(key[2],1)) ^ byte(key[1],1)) ^ byte(key[0],1))
#define q32(x) (q(1,q(0,q(0,(x)) ^ byte(key[2],2)) ^ byte(key[1],2)) ^ byte(key[0],2))
#define q33(x) (q(1,q(1,q(0,(x)) ^ byte(key[2],3)) ^ byte(key[1],3)) ^ byte(key[0],3))

#define q40(x) (q(0,q(0,q(1,q(1,(x)) ^ byte(key[3],0)) ^ byte(key[2],0)) ^ byte(key[1],0)) ^ byte(key[0],0))
#define q41(x) (q(0,q(1,q(1,q(0,(x)) ^ byte(key[3],1)) ^ byte(key[2],1)) ^ byte(key[1],1)) ^ byte(key[0],1))
#define q42(x) (q(1,q(0,q(0,q(0,(x)) ^ byte(key[3],2)) ^ byte(key[2],2)) ^ byte(key[1],2)) ^ byte(key[0],2))
#define q43(x) (q(1,q(1,q(0,q(1,(x)) ^ byte(key[3],3)) ^ byte(key[2],3)) ^ byte(key[1],3)) ^ byte(key[0],3))
#endif


/* G functions */
#ifdef ONE_STEP
#define g0_fun(x) (mk_tab[0][byte(x,0)] ^ mk_tab[1][byte(x,1)] \
                   ^ mk_tab[2][byte(x,2)] ^ mk_tab[3][byte(x,3)])
#define g1_fun(x) (mk_tab[0][byte(x,3)] ^ mk_tab[1][byte(x,0)] \
                   ^ mk_tab[2][byte(x,1)] ^ mk_tab[3][byte(x,2)])
#else
#define g0_fun(x) (mds(0,sb[0][byte(x,0)]) ^ mds(1,sb[1][byte(x,1)]) \
                   ^ mds(2,sb[2][byte(x,2)]) ^ mds(3,sb[3][byte(x,3)]))
#define g1_fun(x) (mds(0,sb[0][byte(x,3)]) ^ mds(1,sb[1][byte(x,0)]) \
                   ^ mds(2,sb[2][byte(x,1)]) ^ mds(3,sb[3][byte(x,2)]))
#endif

/* mds_rem */
u4byte mds_rem(u4byte p0,u4byte p1)
{
    u4byte i,t,u;
    for(i=0;i<8;++i) {
        t=p1>>24;
        p1=(p1<<8)|(p0>>24); p0<<=8;
        u=(t<<1);
        if(t&0x80) u^=0x14d;
        p1^=t|(u<<16);
        u^=(t>>1);
        if(t&0x01) u^=(0x14d>>1);
        p1^=(u<<24)|(u<<8);
    }
    return p1;
}

/* set_key, encrypt, decrypt */
u4byte* set_key(const u4byte key[], const u4byte len)
{
    k_len = len;
    for(u4byte i=0;i<len;++i)
        l_key[i]=key[i];
    gen_qtab();
    return l_key;
}

static inline u4byte rol(u4byte val, int n) {
    return (val << n) | (val >> (32 - n));
}

static inline u4byte ror(u4byte val, int n) {
    return (val >> n) | (val << (32 - n));
}


void encrypt(const u4byte pt[4], u4byte ct[4])
{
    u4byte t0, t1, F0, F1;
    u4byte r0 = pt[0] ^ l_key[0];
    u4byte r1 = pt[1] ^ l_key[1];
    u4byte r2 = pt[2] ^ l_key[2];
    u4byte r3 = pt[3] ^ l_key[3];

    // Calcula as funÃ§Ãµes g

    r1 = ror(r1, 1); // exemplo: rotaciona t1 1 bits Ã  direita

    t0 = g0_fun(r0);
    t1 = g1_fun(r1);

    // ðŸ”¹ Adiciona rotaÃ§Ãµes na Feistel
    // ðŸ”¹ Aplica a PHT
    F0 = (t0 + t1) & 0xFFFFFFFF;
    F1 = (t0 + (t1 << 1)) & 0xFFFFFFFF;  // (t0 + 2*t1) mod 2^32

    r2 = rol(r2, 1); // exemplo: rotaciona t0 1 bits Ã  esquerd
    r3 = ror(r3, 1); // exemplo: rotaciona t1 1 bits Ã  direita


    // ðŸ”¹ Mistura com as metades opostas e subchaves
    ct[0] = F0 ^ r2 ^ l_key[4];
    ct[1] = F1 ^ r3 ^ l_key[5];
    ct[2] = r0;
    ct[3] = r1;
}

void decrypt(const u4byte ct[4], u4byte pt[4]) {
    u4byte t0, t1, F0, F1;
    u4byte r0, r1_rot, r1_plain, r2_rot, r3_rot, r2_plain, r3_plain;

    /* Recupera r0 e o r1 armazenado em ct (note: ct[3] guarda r1 jÃ¡ rotacionado no encrypt) */
    r0 = ct[2];         // no encrypt ct[2] = r0 (sem rotaÃ§Ã£o)
    r1_rot = ct[3];     // no encrypt ct[3] = r1 apÃ³s r1 = ror(r1,1)

    /* Calcula t0 e t1 usando exatamente as mesmas entradas que o encrypt usou:
       encrypt usou g0_fun(r0) e g1_fun(r1_rot) (r1 jÃ¡ rotacionado). */
    t0 = g0_fun(r0);
    t1 = g1_fun(r1_rot);

    /* Recalcula a PHT (F0, F1) */
    F0 = (t0 + t1) & 0xFFFFFFFF;
    F1 = (t0 + (t1 << 1)) & 0xFFFFFFFF;

    /* Recupera os valores rotacionados de r2 e r3 que foram misturados em ct[0]/ct[1] */
    r2_rot = ct[0] ^ F0 ^ l_key[4];   // ct[0] = F0 ^ r2_rot ^ l_key[4]
    r3_rot = ct[1] ^ F1 ^ l_key[5];   // ct[1] = F1 ^ r3_rot ^ l_key[5]

    /* Desfaz as rotaÃ§Ãµes que encrypt aplicou:
       encrypt fez: r2 = rol(r2,1)  --> desfazer com ror(r2_rot,1)
                    r3 = ror(r3,1)  --> desfazer com rol(r3_rot,1)
       AlÃ©m disso, o r1 que estava em ct[3] Ã© r1_rot = ror(original_r1,1),
       entÃ£o para obter o original fazemos r1_plain = rol(r1_rot,1) antes do whitening. */
    r2_plain = ror(r2_rot, 1);
    r3_plain = rol(r3_rot, 1);
    r1_plain = rol(r1_rot, 1);

    /* Remove o whitening (subchaves iniciais) para obter o plaintext */
    pt[0] = r0 ^ l_key[0];
    pt[1] = r1_plain ^ l_key[1];
    pt[2] = r2_plain ^ l_key[2];
    pt[3] = r3_plain ^ l_key[3];
}



void rodarMain(char *frase,u4byte key[4],char *cripto,char *decripto){
	 // ðŸ”¹ Chave de exemplo (128 bits)

	    set_key(key, 4);


	    // ðŸ”¹ Processa o texto em blocos de 16 bytes



	        u4byte pt[4] = {0};
	        u4byte ct[4] = {0};
	        u4byte dt[4] = {0};

	        // Copia 16 bytes do texto para o bloco
	        memcpy(pt, frase, 16);

	        // Cifra o bloco
	        encrypt(pt, ct);
	       memcpy(cripto , ct, 16);

		   // Descriptografa
		   decrypt(ct, pt);

		   // Copia o bloco descriptografado para o buffer final
		   memcpy(decripto , pt, 16);





}


